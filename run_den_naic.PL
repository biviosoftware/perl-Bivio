#!perl
#
# $Id$
#
use Cwd ();
@ARGV || die('usage: perl run_httpd.pl <port>');
$ENV{PERLLIB} = '.';
open(OUT, ">run_httpd.conf") || die;
my($user) = getpwuid($>) || $>;
my($group) = getgrgid($)) || $);
my($pwd) = &Cwd::cwd();
my($port) = shift;
my($host) = `hostname`;
chop($host);
$host = sprintf("%d.%d.%d.%d", unpack('C4', (gethostbyname($host))[4]));
while (<DATA>) {
    # Yup, want an extra "e" to get double interpolation.  Kewl, huh?
    s/<(\$\w+)>/$1/eeg;
}
continue {
    print OUT;
}
close(OUT);
sub symlink ($$) {
    my($file, $link) = @_;
    -e $link || symlink($file, $link) || die("symlink($file, $link): $!");
}
-e 'html' || mkdir('html', 0755) || die("mkdir(html): $!");
&symlink('../../../html/i', 'html/i');
&symlink('../../data', 'data');
&symlink('.', 'Bivio');
&symlink('.', 'logs');
&symlink('/usr/local/apache/libexec', 'libexec');
-e 'data/clubs/cosmic/messages/maillist.html'
    || system('mhonarc -rc ../../etc/majordomo/club.mrc -outdir data/clubs/cosmic/messages/ /usr/local/mail/archive/cosmic.1999??');
system('rm -f httpd.lock.* httpd.pid');
exec('/usr/local/apache/bin/httpd', '-X', '-d', $pwd, '-f', "$pwd/run_httpd.conf");
__DATA__
#
# This file was dynamically generated by <$0>
#
ResourceConfig /dev/null
AccessConfig /dev/null

#
# Server
#
ServerName <$host>
ServerType standalone
Listen <$port>
User <$user>
Group <$user>
ServerAdmin <$user>
UseCanonicalName on
# Single server has strange behaviour
KeepAlive off

#
# Perl
#
PerlWarn on
# Can't be on and use PERLLIB.
#PerlTaintCaheck on
PerlFreshRestart off
PerlSetEnv BIVIO_REQUEST_DEBUG 1
PerlModule Bivio::Club

#
# Files
#
# logs is linked to /var/log/httpd.  conf is linked to /etc.
ServerRoot <$pwd>
DocumentRoot <$pwd>/html
PidFile httpd.pid
ErrorLog |cat
# Possible values include: debug, info, notice, warn, error, crit,
# alert, emerg.
LogLevel debug
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
CustomLog |cat combined
TypesConfig /etc/mime.types
DefaultType text/html
LockFile httpd.lock
HostnameLookups off

DirectoryIndex index.html
<Directory />
AllowOverride None
Options FollowSymLinks
</Directory>

<Location /denver-register>
SetHandler perl-script
PerlHandler Bivio::NAICRegister
</Location>

#
# Browsers
#
BrowserMatch "Mozilla/2" nokeepalive
BrowserMatch "MSIE 4\.0b2;" nokeepalive downgrade-1.0 force-response-1.0
BrowserMatch "RealPlayer 4\.0" force-response-1.0
BrowserMatch "Java/1\.0" force-response-1.0
BrowserMatch "JDK/1\.0" force-response-1.0
