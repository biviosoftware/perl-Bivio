# Copyright (c) 2008 bivio Software Inc.  All Rights Reserved.
# $Id$
test_setup('PetShop');
home_page();
my($forum) = generate_remote_email('crm_forum');
my($cust1) = generate_local_email('crm_cust1');
my($tech1) = generate_local_email('crm_tech1');
my($msg) = send_mail($cust1, $forum);
my($ticket, $subject) = verify_local_mail($tech1, qr{.}, 1)
    =~ m{^Subject: .*#(\d+)\].*(.*)$}mi;
die('no ticket')
    unless $ticket;
login_as('crm_tech1');
visit_uri('/crm_forum/tickets');
submit_form(refresh => {
    status => 'new',
});
do_table_rows('Last Update', sub {test_equals(qr{new}i, shift->{Status})});
submit_form(refresh => {
    status => 'open',
});
my($status) = {};
verify_no_text('list is empty');
do_table_rows('Last Update', sub {
    $status->{shift->{Status}->as_string}++;
    return 1;
});
test_ok($status->{New}, 'Open status filter not including New threads');
foreach my $s (qw(Closed Locked)) {
    test_ok(!$status->{$s}, "Open status filter is including $s threads");
}
while(get_html_parser()->get('Links')->unsafe_get('New')) {
    follow_link('New', 'internally');
    submit_form(only => {action => 'Close'});
}
