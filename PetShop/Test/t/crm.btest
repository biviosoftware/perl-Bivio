# Copyright (c) 2008 bivio Software, Inc.  All Rights Reserved.
# $Id$
test_setup('PetShop');
home_page();
my($forum) = generate_remote_email('crm_forum');
my($cust1) = generate_local_email('crm_cust1');
my($tech1) = generate_local_email('crm_tech1');
my($msg) = send_mail($cust1, $forum);
my($ticket) = verify_local_mail($tech1, qr{.}, 1) =~ m{#(\d+)\]}i;
die('no ticket')
    unless $ticket;
login_as('crm_tech1');
visit_uri('/crm_forum/tickets');
follow_link_in_table('Ticket', 'Subject', $msg->unsafe_get_header('Subject'));
follow_link('answer');
verify_text("Locked Ticket #$ticket");
verify_text(qr{Cc:.*\Q$cust1}s);
submit_form(Send => {
    action => 'Close',
    text => 'Solution here',
});
follow_link('tickets');
my($subject) = verify_local_mail($cust1, qr{.}, 1) =~ /Subject:\s+([^\n]+)/m;
die('no subject')
    unless $subject;
$msg = verify_local_mail($tech1, qr{.}, 1);
$msg =~ /^Sender: crm\@/im || die('incorrect Sender: ', $msg);
submit_form(Refresh => {
    'Any Status' => 'Any Status', # force filter to Any Status
});
follow_link_in_table('Ticket', 'Ticket', $ticket);
verify_text("Closed Ticket #$ticket");
my($body) = 'but wait ' . random_string();
$msg = send_mail($cust1, $forum, {Subject => $subject}, $body);
verify_local_mail($tech1, qr{.}, 1);
reload_page();
verify_text($body);
verify_text("Open Ticket #$ticket");
follow_link('Show Original');
test_equals('text/plain', get_response()->content_type);

# Audit log is the email stream, like tuple, but action
# is simple notification
# verify_text(qr{last update by.*tech1});
# submit_form({
#     assign => 'cust_tech2',
# });
