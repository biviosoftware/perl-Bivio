# Copyright (c) 2006-2011 bivio Software, Inc.  All Rights Reserved.
# $Id$
test_setup('PetShop');
visit_uri((create_forum())[1]);

follow_link(qw(tables schemas add_schema));
submit_form(Save => {
    schema_name => 'b_motion_comment',
    mail_prefix => 'b_motion_comment',
    field_0 => 'Proposed_Change',
    type_0 => 'String',
    field_1 => 'Due_Date',
    type_1 => 'Date',
});
follow_link(qw(tables add_table));
submit_form({
    schema => 'b_motion_comment',
});

follow_link(qw(schemas add_schema));
submit_form(Save => {
    schema_name => 'b_motion_comment2',
    mail_prefix => 'b_motion_comment2',
    field_0 => 'Extra_Field',
    type_0 => 'String',
});
follow_link(qw(tables add_table));
submit_form({
    schema => 'b_motion_comment2',
});

follow_link('polls');
verify_text(qr/no polls/i);
follow_link('new_poll');
#verify_text(qr{one vote per user}i);
my($motion) = 'Test Motion 1';
test_deviance('must supply a value');
submit_form({
    name => $motion,
});
test_conformance();
submit_form({
    question => 'Do you like green?',
    comment_format => 'b_motion_comment2',
});
verify_table('Name', [
    ['Name', 'Start', 'End'],
    [$motion, qr/./, ''],
]);
follow_link_in_table('Name', 'Name', $motion, 'Actions', 'Edit');
submit_form({
    document => file_field('doc.txt', 'a document'),
});
follow_link_in_table('Name', 'Name', $motion, 'Document', 'doc.txt');
verify_text('a document');
go_back();

follow_link_in_table('Name', 'Name', $motion, 'Actions', 'Vote');
submit_form({
    _radio => 'Yes',
    comment => 'green rules!',
});
# can change vote
verify_table('Name', [
    ['Name', qr/Votes/, 'Actions'],
    [$motion, '1/0/0', qr/vote/i],
]);
follow_link_in_table('Name', 'Name', $motion, 'Actions', 'Comment');
submit_form({
    comment => 'x',
    extra => 'y',
});
follow_link_in_table('Name', 'Name', $motion, 'Actions', 'View Comments');
verify_table('Name', [
    ['Name', 'Comment', 'Extra Field'],
    ['Root User', 'x', 'y'],
]);

follow_link('polls');
follow_link_in_table('Name', 'Name', $motion, 'Actions', 'Edit');
submit_form({
    name => 'Test Motion One',
    end => 'now',
});
verify_text(qr/the poll has been saved/i);
# WiP

#verify_table('Name', [
#    ['Name', 'Start', 'End'],
#    ['Test Motion One', qr/./, qr/./],
#]);

follow_link_in_table('Name', 'Name', 'Test Motion One', 'Actions', 'Results');
verify_table('Date', [
    ['Vote', 'Comment'],
    ['Yes', 'green rules!'],
]);
follow_link('spreadsheet');
verify_text(qr/yes.*green rules/i);

