# Copyright (c) 2005-2023 bivio Software, Inc.  All Rights Reserved.
use MIME::Base32 ();
test_setup('PetShop');
home_page();
# Deviance cases can't use this inline or they'll fail to die on next call
my($dp) = default_password();
my($rs) = random_string();
my($e) = generate_local_email($rs);
test_deviance();
login_as('', 'bad password');
test_conformance();
verify_no_text('bad password');
test_deviance();
login_as($e, 'bad password');
test_conformance();
verify_no_text('bad password');
follow_menu_link('new_user');
test_deviance('too short');
submit_form(create => {
    'Email:' => $e,
    'Password:' => 'passwd',
    'First Name:' => 'Password',
    'Last Name:' => 'Test',
});
test_deviance('enter a unique password');
submit_form(create => {
    'Email:' => $e,
    'Password:' => $rs,
    'First Name:' => 'Password',
    'Last Name:' => 'Test',
});
submit_form(create => {
    'Email:' => $e,
    'Password:' => 'passwordtest',
    'First Name:' => 'Password',
    'Last Name:' => 'Test',
});
test_conformance();
submit_form(create => {
    'Email:' => $e,
    'Password:' => $dp,
    'First Name:' => 'Password',
    'Last Name:' => 'Test',
});
do_logout();
# need to clear cookies or the deviance Reset Password will fail
clear_cookies();
follow_link(qw(Sign-in forgot_password));
test_deviance('must supply');
submit_form('Reset Password');
test_conformance();
submit_form('Reset Password' => {
    'Email:' => $e,
});
verify_text(qr{An email has been sent to.*\Q$e});
# Verify ack gets cleared
follow_menu_link('home');
go_back();
my($uri) = extract_uri_from_local_mail($e, 'password');
(my $bad = $uri) =~ s/(?<=\=)\S//;
visit_uri($bad);
verify_text('no longer valid');
visit_uri($uri);
my($p) = random_string();
verify_no_text('Current Password');
submit_form('Cancel');
verify_text('Birds');
visit_uri($uri);
verify_text('no longer valid');
do_logout();
follow_link(qw(Sign-in forgot_password));
submit_form('Reset Password' => {
    'Email:' => $e,
});
verify_text(qr{An email has been sent to.*\Q$e});
my($uri1) = extract_uri_from_local_mail($e, 'password');
home_page();
follow_link(qw(Sign-in forgot_password));
submit_form('Reset Password' => {
    'Email:' => $e,
});
verify_text(qr{An email has been sent to.*\Q$e});
my($uri2) = extract_uri_from_local_mail($e, 'password');
visit_uri($uri1);
verify_text('no longer valid');
my($add_seconds) = sub {
    my($seconds) = @_;
    date_time_now(Type_DateTime()->add_seconds(Type_DateTime()->now, $seconds));
    return;
};
$add_seconds->(3 * 60 * 60);
visit_uri($uri2);
verify_text('no longer valid');
$add_seconds->(-3 * 60 * 60);
visit_uri($uri2);
verify_text(qr{type="password".*type="password"}s);
submit_form(Change => {
    'New Password:' => $p,
    'Re-enter New Password:' => $p,
});
follow_link('myaccount', 'change_password');
test_deviance('must supply a value');
submit_form(Change => {
    'Current Password:' => '',
    'New Password:' => $dp,
    'Re-enter New Password:' => $dp,
});
test_deviance('does not match');
submit_form(Change => {
    'Current Password:' => 'wrong password',
    'New Password:' => $dp,
    'Re-enter New Password:' => $dp,
});
test_deviance('password and confirm password');
submit_form(Change => {
    'Current Password:' => $p,
    'New Password:' => "x$dp",
    'Re-enter New Password:' => $dp,
});
test_conformance();
submit_form(Change => {
    'Current Password:' => $p,
    'New Password:' => $dp,
    'Re-enter New Password:' => $dp,
});
do_logout();
login_as($e, $dp);
do_logout();
visit_uri($uri2);
verify_text('no longer valid');
login_as($e, $dp);
follow_link('myaccount', 'enable_time_based');
verify_text('set up two-factor');
my($totp_setup_key) = get_content() =~ /id="totp_setup_key">([^<]+)</;
$totp_setup_key =~ s/\s+//g;
my($compute_totp_code) = sub {
    my($seconds) = @_;
    $seconds //= 30;
    $add_seconds->($seconds);
    do_test_backdoor(UserTOTP => join(' ', '-r', $e, 'compute', MIME::Base32::decode_rfc3548($totp_setup_key)));
    my($code) = get_content();
    chomp($code);
    go_back();
    return $code;
};
follow_link('download');
my($fallback_codes) = [split("\n", get_content())];
go_back();
my($totp_setup_now) = Type_DateTime()->now;
submit_form({
    password => $dp,
    authenticator_code => $compute_totp_code->(),
});
verify_text(qr/two-factor authentication has been set up successfully/i);
verify_text(qr/sign-out/i);
do_logout();
follow_link('sign_in');
submit_form({
    password => $dp,
    email => $e,
});
verify_no_text(qr/sign-out/i);
verify_text(qr/authenticator code/i);
my($totp_code) = $compute_totp_code->();
test_deviance(qr/authenticator code is invalid/i);
submit_form({
    authenticator_code => $totp_code + 1,
});
test_conformance();
# Should generate the same code as was used in setup. Using the same code twice is disallowed.
date_time_now($totp_setup_now);
test_deviance(qr/authenticator code is invalid/i);
submit_form({
    authenticator_code => $totp_code,
});
test_conformance();
$add_seconds->(30);
submit_form({
    authenticator_code => $compute_totp_code->(),
});
do_logout();
home_page();
follow_link(qw(Sign-in forgot_password));
submit_form({
    'Email:' => $e,
});
verify_text(qr{An email has been sent to.*\Q$e});
$uri = extract_uri_from_local_mail($e, 'password');
visit_uri($uri);
verify_text(qr/authenticator code/i);
$add_seconds->(30);
submit_form({
    authenticator_code => $compute_totp_code->(),
});
verify_text(qr/your password/i);
verify_no_text(qr/current password/i);
$p = random_string();
submit_form(Change => {
    'New Password:' => $p,
    'Re-enter New Password:' => $p,
});
verify_text(qr/your password has been changed/i);
do_logout();
$add_seconds->(30);
login_as($e, $p, $compute_totp_code->());
do_logout();
visit_uri($uri);
verify_text('no longer valid');
home_page();
follow_link(qw(Sign-in forgot_password));
submit_form({
    'Email:' => $e,
});
verify_text(qr{An email has been sent to.*\Q$e});
$uri = extract_uri_from_local_mail($e, 'password');
visit_uri($uri);
verify_text(qr/authenticator code/i);
# TODO: handle_cookie_in gets processed before DateTime handle_pre_execute_task, so expiration ends up being after "now" according to cookie processing
# $add_seconds->(30);
submit_form({
    fallback_code => $fallback_codes->[int(rand(int(@$fallback_codes)))],
});
verify_text(qr/your password/i);
verify_no_text(qr/current password/i);
$p = random_string();
submit_form(Change => {
    'New Password:' => $p,
    'Re-enter New Password:' => $p,
});
verify_text(qr/your password has been changed/i);
do_logout();
$add_seconds->(30);
login_as($e, $p, $compute_totp_code->());
do_logout();


# verify two-factor workflows
# exercise cancel on all forms

follow_link(qw(Sign-in forgot_password));
submit_form('Reset Password' => {
    'Email:' => $e,
});
verify_text(qr{An email has been sent to.*\Q$e});
$uri = extract_uri_from_local_mail($e, 'password');
$add_seconds->(3 * 60 * 60);
visit_uri($uri);
verify_text('no longer valid');
home_page();
follow_link(qw(Sign-in forgot_password));
verify_form({
    'Email:' => $e,
});
test_deviance('You are not allowed');
submit_form('Reset Password' => {
    'Email:' => ShellUtil_SQL()->ROOT_EMAIL,
});
test_conformance();
login_as('root');
visit_uri('/adm/su');
submit_form({
    email => $e,
});
follow_menu_link(qw(groupware wiki));
verify_text('Acting as User');
do_test_backdoor(RealmAdmin => "-force -u $e -r $e reset_password x$dp");
go_back();
follow_menu_link('wiki');
verify_no_text('Acting as User');
do_test_backdoor(RealmAdmin => "-force -u $e -r $e reset_password $dp");
