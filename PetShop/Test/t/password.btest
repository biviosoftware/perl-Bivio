# Copyright (c) 2005 bivio Software, Inc.  All Rights Reserved.
# $Id$
test_setup('PetShop');
home_page();
# Deviance cases can't use this inline or they'll fail to die on next call
my($dp) = default_password();
my($e) = generate_local_email(test_name());
test_deviance();
login_as($e, 'bad password');
test_conformance();
if (text_exists('not found')) {
    follow_link('New User');
    submit_form(submit => {
	'Email:' => $e,
	'Password:' => $dp,
	'First Name:' => 'Password',
	'Last Name:' => 'Test',
    });
    do_logout();
    # need to clear cookies or the deviance Reset Password will fail
    clear_cookies();
}
follow_link('Sign-in');
follow_link('Forgot Password?');
test_deviance('must supply');
submit_form('Reset Password');
test_conformance();
submit_form('Reset Password' => {
    'Email:' => $e,
});
verify_text(qr{An email has been sent to.*\Q$e});
my($uri) = verify_local_mail($e, 'password') =~ /(http:.+\?.+)/m;
(my $bad = $uri) =~ s/(?<=\=)\S//;
visit_uri($bad);
verify_text('no longer valid');
visit_uri($uri);
my($p) = random_string();
verify_no_text('Current Password');
submit_form('Cancel');
verify_text('Account Information');
visit_uri($uri);
submit_form(Change => {
    'New Password:' => $p,
    'Re-enter New Password:' => $p,
});
follow_link(qr/password/i);
test_deviance('must supply a value');
submit_form(Change => {
    'Current Password:' => '',
    'New Password:' => $dp,
    'Re-enter New Password:' => $dp,
});
test_deviance('does not match');
submit_form(Change => {
    'Current Password:' => 'wrong password',
    'New Password:' => $dp,
    'Re-enter New Password:' => $dp,
});
test_deviance('password and confirm password');
submit_form(Change => {
    'Current Password:' => $p,
    'New Password:' => "x$dp",
    'Re-enter New Password:' => $dp,
});
test_conformance();
submit_form(Change => {
    'Current Password:' => $p,
    'New Password:' => $dp,
    'Re-enter New Password:' => $dp,
});
do_logout();
follow_link('Sign-in');
follow_link('Forgot Password?');
verify_form({
    'Email:' => $e,
});
test_deviance('You are not allowed');
submit_form('Reset Password' => {
    'Email:' => test_use('Bivio::PetShop::Util')->ROOT_EMAIL,
});
